<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>L20n tinker</title>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
      h1 {
        margin-bottom: 2em;
      }
      #source {
        position: relative;
        width: 25em;
        height: 30em;
      }
      .popover {
        z-index: 9999;
      }
    </style>


    <script type="text/javascript" src="../js/lib/events.js"></script>
    <script type="text/javascript" src="../js/lib/parser.js"></script>
    <script type="text/javascript" src="../js/lib/compiler.js"></script>
  </head>
  <body>
    <h1>L20n tinker</h1>
    <div class="container-fluid">
      <div class="row-fluid">
        <div class="span4">
          <div id="source"></div>
        </div>
        <dl class="span4" id="output"></dl>
        <dl class="span4" id="errors"></dl>
      </div>
    </div>

    <script src="http://code.jquery.com/jquery-1.9.0.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
    <script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

    <script type="text/javascript">
      var source = ace.edit("source");
      source.setTheme("ace/theme/monokai");
      source.getSession().setMode("ace/mode/clojure");

      var parser = new L20nParser(L20nEventEmitter);
      var compiler = new L20nCompiler(L20nEventEmitter, L20nParser);

      parser.addEventListener('error', function(e) {
        $("#errors").append("<dt>Syntax error at position " + e.pos + "</dt><dd>" + e.message + "</dd>");
      });
      compiler.addEventListener('error', function(e) {
        $("#errors").append("<dt>" + e.name + " in entity <code>" + e.entry + "</code></dt><dd>" + e.message + "</dd>");
      });
      compiler.addEventListener('inner', console.log);

      source.getSession().on('change', function(e) {
        $("#output").empty();
        $("#errors").empty();
        var code = source.getValue();
        var ast = parser.parse(code);
        var entries = compiler.compile(ast);
        for (var id in entries) {
          var val;
          try {
            val = entries[id].toString();
          } catch (e) {
            if (e instanceof compiler.ValueError) {
              val = e.source;
            } else {
              continue;
            }
          }
          $("#output").append("<dt><code>" + id + "</code></dt><dd>" + val + "</dd>");
        }
      });

    </script>
  </body>
</html>
