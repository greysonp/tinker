<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>L20n tinker</title>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <script type="text/javascript" src="../js/lib/events.js"></script>
    <script type="text/javascript" src="../js/lib/parser.js"></script>
    <script type="text/javascript" src="../js/lib/compiler.js"></script>
  </head>
  <body>
    <div class="navbar navbar-static-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a id="logo" class="brand" href="#">L20n tinker</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active"><a class="context" href="#context">Context Data</a></li>
              <li class="active"><a class="globals" href="#globals">Globals</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
      <div class="row-fluid">

        <div id="source-wrapper" class="span4">
          <header>Source</header>
          <div id="source"></div>
        </div>

        <div id="output-wrapper" class="span4">
          <header>Output</header>
          <dl id="output" />
        </div>

        <div id="errors-wrapper" class="span4">
          <header>Errors</header>
          <dl id="errors" />
        </div>

      </div>
    </div>

    <script src="http://code.jquery.com/jquery-1.9.0.min.js"></script>
    <script src="script.js"></script>
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/js/bootstrap.min.js"></script>
    <script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

    <script type="text/javascript">
      var source = ace.edit("source");
      source.getSession().setMode("ace/mode/clojure");

      var parser = new L20nParser(L20nEventEmitter);
      var compiler = new L20nCompiler(L20nEventEmitter, L20nParser);

      parser.addEventListener('error', function(e) {
        $("#errors").append("<dt>Syntax error at position " + e.pos + "</dt><dd>" + e.message + "</dd>");
      });
      compiler.addEventListener('error', function(e) {
        $("#errors").append("<dt>" + e.name + " in entity <code>" + e.entry + "</code></dt><dd>" + e.message + "</dd>");
      });

      source.getSession().on('change', function(e) {
        $("#output").empty();
        $("#errors").empty();
        var code = source.getValue();
        var ast = parser.parse(code);
        var entries = compiler.compile(ast);
        for (var id in entries) {
          var val;
          try {
            val = entries[id].toString();
          } catch (e) {
            if (e instanceof compiler.ValueError) {
              val = e.source;
            } else {
              continue;
            }
          }
          $("#output").append("<div><dt><code>" + id + "</code></dt><dd>" + val + "</dd></div>");
        }
      });

    </script>
  </body>
</html>
